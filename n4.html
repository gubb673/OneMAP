<!DOCTYPE html>
<html>
<head>
	<!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzMDSMPcKm03bAx6irSrBhZU3tq5UMG-g&sensor=false" type="text/javascript"></script>-->
	<script src="http://ditu.google.cn/maps/api/js?" type="text/javascript"></script>
	<!--key=AIzaSyBzMDSMPcKm03bAx6irSrBhZU3tq5UMG-g-->
	<!--<script async defer src=" http://ditu.google.cn/maps/api/js?key=AIzaSyBzMDSMPcKm03bAx6irSrBhZU3tq5UMG-g**callback=inim**" type="text/javascript"></script>-->
	<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css' rel='stylesheet' />

    
    <!-- https://datatables.net/examples/basic_init/zero_configuration.html -->
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


	
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
	<script src="https://code.jquery.com/jquery-3.2.1.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
	
	<!-- mapbox gl -->
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js'></script>
	
	
	<script src="js/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<!--<script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyDC79mAhKoODsuNmZPYNMNFomVVbb8l0Ls&sensor=false"></script>-->
	<!--<script  src="http://maps.google.com/maps/api/js?key=AIzaSyBzMDSMPcKm03bAx6irSrBhZU3tq5UMG-g" type="text/javascript"></script>-->
	
	<script type='text/javascript' src='js/jscolor.js'></script>
	<script type='text/javascript' src='js/papaparse.min.js'></script>
	
	
	
	<style>
		#div1{
		}
		#div2{
		float:left;
		width:79%;
		}
		#div3{
		float:left;
		width:1%;
		}
		#divp{
		float:left;
		width:20%;
		}
		<!--body { margin:0; padding:0; }-->
		#map { position:absolute; top:0; bottom:0; width:100%; height:90%;}
		.slider {
			-webkit-appearance: none;
			width: 100%;
			height: 15px;
			border-radius: 5px;   
			background: #d3d3d3;
			outline: none;
			opacity: 0.7;
			-webkit-transition: .2s;
			transition: opacity .2s;
		}

		.slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 25px;
			height: 25px;
			border-radius: 50%; 
			background: #0821A4;
			cursor: pointer;
		}

		.slider::-moz-range-thumb {
			width: 25px;
			height: 25px;
			border-radius: 50%;
			background: #0821A4;
			cursor: pointer;
		p{line-height:20px;  padding-top:5px}
		}
		
		
}
	</style>
</head>
<body>

<div class="container" id="divp">
	  <h2>Mapping</h2>
	  <p>Click on the collapsible panel to open and close it.</p>
	  <div id="div1"  class="panel-group">
		<div class="panel panel-default">
		  <div class="panel-heading">
			<h4 class="panel-title">
			  <a data-toggle="collapse" href="#collapse1">Project</a>
			</h4>
		  </div>
		  <div id="collapse1" class="panel-collapse collapse">
			<div class="panel-body">
			<ul class="list-group list-group-flush" >
				<li class="list-group-item">
				<label class="btn btn-default btn-file" style="width:100%">
					Input <input type="file" style="display: none;"  onchange="handleFiles(this.files)">
				</label>
				</li>
				<li class="list-group-item">
				<button type="button" class="btn btn-primary"   onclick="DownloadCurrentMap()" style="width:100%">Download</button>
				<a id="CurrentMapImage"> Click to download the image</a>
				</li>
			</ul>
			</div>
			
		  </div>
		</div>
		<div class = "panel-group">
		<div class="panel panel-default">
		   <div class="panel-heading">
			<h4 class="panel-title">
			  <a data-toggle="collapse" href="#collapse2">Map Option</a>
			</h4>
		  </div>
		   <div id="collapse2" class="panel-collapse collapse">
		    <div class="panel-body">
			 <ul class="list-group list-group-flush" >
			   <li class="list-group-item">
				<div class="dropdown" >
					<button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="width:100%">
					Map Style
					</button>
					<div class="dropdown-menu" aria-labelledby="dropdownMenu2">
					<button class="dropdown-item" type="button" value="streets" onclick="ModifyBaseMap(value)">Streets</button>
					<button class="dropdown-item" type="button" value="outdoors" onclick="ModifyBaseMap(value)">Outdoor</button>
					<button class="dropdown-item" type="button" value="light" onclick="ModifyBaseMap(value)">Light</button>
					<button class="dropdown-item" type="button" value="dark" onclick="ModifyBaseMap(value)">Dark</button>
					<button class="dropdown-item" type="button" value="satellite" onclick="ModifyBaseMap(value)">Satellite</button>
					<button class="dropdown-item" type="button" value="satellite-streets" onclick="ModifyBaseMap(value)">Satellite streets</button>
					</div>
				</div>
			   </li>
			   <li class="list-group-item">
			    <div class="slidecontainer">
				 <p>Size:</p>
					<input type="range" min="1" max="20" value="5" class="slider" id="IconSize" class="slider-square" onchange="ChangeIconProperty(value,'circle-radius')">
				</div>
				<div>
				<p></br>Color: </p>
				<input id="colorinput" class="jscolor" value="81D8D0" style=" width: 100%" onchange="ChangeIconProperty(value,'circle-color')">
				</div>
			   </li>
			   <li class="list-group-item">
				 <label class="radio-inline"><input type="radio" name="optradio" value="N" checked > Normal </label> </br>
				 <label class="radio-inline"><input type="radio" name="optradio" value="C"> Cluster </label></br>
				 <label class="radio-inline"><input type="radio" name="optradio" value="H">HeatMap</label>
			   </li>
			 </ul>
			</div>
		   </div>
		 </div style = "height: 20%">
		</div>
		</div class = "panel-group">
		<div class="panel-group">
		<div class="panel panel-default">
		
		  <div class="panel-heading">
			<h4 class="panel-title">
			  <a data-toggle="collapse" href="#collapse3">Geocoding</a>
			</h4>
		  </div>
		  <div id="collapse3" class="panel-collapse collapse">
			<div class="panel-body">
			<ul class="list-group list-group-flush" >
				<li class="list-group-item">
				<textarea id="addressBar" style = "height: 30%; width: 100%"> 南京西路50号,莘庄地铁站 </textarea>
				</li>
				<li class="list-group-item">
				<button onclick="GetAddress()" style = "width: 100px; height:30px"> GEOCODE </button>
				</li>
				<li class="list-group-item">
				<a id="GeoCodeResultDownload">CSV from local store</a>
				</li>
			</ul>
			</div>
			
		  </div>
		</div>
		</div>
	  	<div class="panel-group">
		<div class="panel panel-default">
		
		  <div class="panel-heading">
			<h4 class="panel-title">
			  <a data-toggle="collapse" href="#collapse4">Label</a>
			</h4>
		  </div>
		  <div id="collapse4" class="panel-collapse collapse">
			<div class="panel-body">
			<ul class="list-group list-group-flush" >
				<li class="list-group-item">
					 <input type="checkbox" class="form-check-input" id="exampleCheck1" onchange="LabeltheFeature()">&nbsp;&nbsp;&nbsp;&nbsp;
					 <label class="form-check-label" for="exampleCheck1">Label the layer</label>
				</li>
				<li class="list-group-item">
					<div class="slidecontainer">
						<p>Size:</p>
						<input type="range" min="1" max="20" value="5" class="slider" id="TextSize" class="slider-square" onchange="ChangeIconProperty(value,'text-size')">
					</div>
					<div>
					<p></br>Color: </p>
					<input id="textcolor" class="jscolor" value="81C8C0" style=" width: 100%" onchange="ChangeIconProperty(value,'text-color')">
					</div>
				</li>
				
				<li class="list-group-item">
				
				</li>
			</ul>
			</div>
			
		  </div>
		</div>
		</div>
	  </div>
</div>


<div id="div2">

	<div  id='map' style="position:relative ; height:1000px"></div>
	<div style="position:relative ; height:20px">

	</div>
	<div style="height: 150px">
	<textarea id='editBar' " style="float:left"> 6666 </textarea>
	<div>
		<div class="dropdown" style="float:left" >
		<button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="width:100%">
					Map Style
					</button>
					<div id = "LatDropDownContent" class="dropdown-menu" aria-labelledby="dropdownMenu2">

					</div>
		</div>
	</div>
	<table id='example' class="table table-striped table-bordered" style="width:100%">
	
	</table>
	</div>
</div>
<div id="div3">
<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>


<script type="text/javascript">
var GeoCodeTextResult; //the result of geocoding
var LabelPointLayer = false;
var nowaddressindex = 0;
var testadresstext;
var addresslist;
var editor;
var Cluster = false;
var Heatmap = false;
var Normal =  true;
var geocoder = new google.maps.Geocoder();
var CircleSize = 10;
var CircleColor = "#82D3A2";
var TextColor = "#828201";
var TextSize = 12;

mapboxgl.accessToken = 'pk.eyJ1IjoiZ3ViYjY3MyIsImEiOiJjaXFqMDR4OWQwODRxZnJtMWhpaWtxbnBzIn0.JeBpEcWX8PvM4Mu9-rKqQA';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/basic-v9',
    zoom: 13,
    center: [114.1095,22.3964],
	preserveDrawingBuffer: true
});


 $('#example').on( 'click', 'tbody td', function (e) {
           this.innerHTML = document.getElementById("editBar").value;
    } );
$("input[name=optradio]").change(function () {

        if(this.value == "N")
        {
		   Normal  = true;
           Cluster = false;
		   Heatmap = false;
        }
        if(this.value == "C")
        {
		   Normal  = false;
           Cluster = true;
		   Heatmap = false;
        }
		if(this.value == "H")
        {
			Normal  = false;
           Cluster = false;
		   Heatmap = true;
		}
		RefreshMap();
});
function GetAddress(){
   var addressarray = document.getElementById("addressBar").value;
   addresslist = addressarray.split(',');
   nowAccept = 0;
   nowaddressindex = 0;
   GeoCodeTextResult = "";
   GeoCodeText();
   
 
}
function LabeltheFeature(){
 LabelPointLayer = !LabelPointLayer;
 RefreshMap();
}
function DownloadCurrentMap(){

  
  var a = document.querySelector("#CurrentMapImage"); // id of the <a> element to render the download link
  
  var img = map.getCanvas().toDataURL('image/png');
  a.setAttribute('href', img);

  a.download = "CurrentMap.jpg";
}
function exportData() {
        var item = localStorage.csv=GeoCodeTextResult;

        var ary = localStorage.getItem( "csv" ); //csv as a string
        var blob = new Blob([ary], {type: "text/csv"});
        var url = URL.createObjectURL(blob);
        var a = document.querySelector("#GeoCodeResultDownload"); // id of the <a> element to render the download link
		var str = encodeURIComponent(GeoCodeTextResult);
		a.setAttribute('href', 'data:text/csv; charset=utf-8,\ufeff' + str);
        //a.href = url;
        a.download = "file.csv";

    }
function GeoCodeText()
{   
        var A = addresslist[nowaddressindex];
		geocoder.geocode( {'address': addresslist[nowaddressindex]}, function(results, status,aa=A) {

		if (status == google.maps.GeocoderStatus.OK) {
			var latitude = results[0].geometry.location.lat();
			var longitude = results[0].geometry.location.lng();
			console.log(latitude);
			console.log(longitude);
			GeoCodeTextResult = GeoCodeTextResult.concat(aa,",\"",results[0].formatted_address,"\",",latitude,",",longitude,"\r\n");
            } 
		nowAccept=nowAccept+1;
		if(nowAccept == addresslist.length)
		{
		  exportData();
		}

        }); 
	
		nowaddressindex=nowaddressindex+1;
		if(nowaddressindex<addresslist.length){
		   GeoCodeText();
		}
		
	
}




function inim(){
  geocoder  = new google.maps.Geocoder();
};

var geoJsonData = {
  
  type: "FeatureCollection",
  features: []
};

var geojsondatafortest = {
  "type": "FeatureCollection",
                    "features": [{
                        "type": "Feature",
                        "geometry": {
                            "type": "Point",
                            "coordinates": [114.1095,22.3964]
                        },
						"properties": {
                        "title": "Mapbox SF",
                        "icon": "harbor"
                       }
                    }]
}

    map.on('style.load', function() {
      RefreshMap();
    });
	function RefreshMap(){
		if(map.getLayer('points'))
		{map.removeLayer('points');}
		if(map.getLayer('clusters-label')){
		map.removeLayer('clusters-label');}
		if(map.getSource('ptsdata'))
		{map.removeSource('ptsdata');}
	  
		map.addSource('ptsdata', {
                "type": "geojson",
                "data": geoJsonData,
				"cluster": Cluster
            })
		map.addLayer({
            "id": "points",
            "type": ((Heatmap)?"heatmap":"circle"),
            "source":"ptsdata",
			paint: getPaint(),
			
        });
		if(LabelPointLayer){
		map.addLayer({
			"id": "clusters-label",
			"type": "symbol",
			"source":"ptsdata",
			"layout":{
				"text-field": "{FeatureName}",
				"text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
				"text-size": TextSize,
				
			 },
			"paint":{
				"text-color": TextColor
			}
		});
		}
	}
	
	function getPaint(){
	if(Cluster){
	  return {"circle-color": [
                "step",
                ["get", "point_count"],
                "#51bbd6",
                5,
                "#f1f075",
                25,
                "#f28cb1",
				50,
				"#e80603"
            ],
            "circle-radius": [
                "step",
                ["get", "point_count"],
                5,
                5,
                10,
                25,
                20,
				50,
				30
            ]};
	}
	if(Normal){
	return{
		"circle-radius": CircleSize,
		"circle-color": CircleColor,
		"circle-opacity": 0.6,
		
	};
	}
	if(Heatmap){
	return {
	         // Increase the heatmap weight based on frequency and property magnitude
            "heatmap-weight": [
                "interpolate",
                ["linear"],
                ["get", "mag"],
                0, 0,
                6, 1
            ],
            // Increase the heatmap color weight weight by zoom level
            // heatmap-intensity is a multiplier on top of heatmap-weight
            "heatmap-intensity": [
                "interpolate",
                ["linear"],
                ["zoom"],
                0, 1,
                20, 1
            ],
            // Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
            // Begin color ramp at 0-stop with a 0-transparancy color
            // to create a blur-like effect.
            "heatmap-color": [
                "interpolate",
                ["linear"],
                ["heatmap-density"],
                0, "rgba(33,102,172,0)",
                0.2, "rgb(103,169,207)",
                0.4, "rgb(209,229,240)",
                0.6, "rgb(253,219,199)",
                0.8, "rgb(239,138,98)",
                1, "rgb(178,24,43)"
            ],
            // Adjust the heatmap radius by zoom level
            "heatmap-radius": [
                "interpolate",
                ["linear"],
                ["zoom"],
                0, 2,
                1, 20
            ],
            // Transition from heatmap to circle layer by zoom level
            "heatmap-opacity": [
                "interpolate",
                ["linear"],
                ["zoom"],
                7, 1,
                20, 0
            ]}
	}
	}
	function addlayerswithvalue(value){
	RefreshMap();

   };
	function ModifyBaseMap(value){
		//map.setStyle(require('mapbox-gl-styles/styles/' + value + '-v9'));
		//map.setStyle('mapbox-gl-styles/styles/' + value + '-v9');
	    map.setStyle('mapbox://styles/mapbox/' + value + '-v9');
		//map.setLayoutProperty('basemap', 'sprite','mapbox://styles/mapbox/' + value + '-v9');
	}
	function handleFiles(files) {
      // Check for the various File API support.
      if (window.FileReader) {
          // FileReader are supported.
          getAsText(files[0]);
      } else {
          alert('FileReader are not supported in this browser.');
      }
    }
    function ChangeIconSize(value){
	   map.setPaintProperty("points", "circle-radius", Number(value));
	 
	}
	function ChangeIconProperty(value,pt){
	   var a = "#";
	   a+=value;
	   if(pt=="circle-color"){
	   CircleColor = a;
	   map.setPaintProperty("points", "circle-color", a);}
	   
	   if(pt=="circle-radius"){
	   CircleSize = Number(value);
	   map.setPaintProperty("points", "circle-radius", Number(value));
	   }
	   
	   if(pt=="text-size"){
	   TextSize = Number(value);
	   map.setLayoutProperty("clusters-label","text-size",Number(value));
	   }
	   
	   if(pt=="text-color"){
	   TextColor = a;
	   map.setPaintProperty("clusters-label","text-color",a);
	   }
	   
	 
	}
	
	
    function getAsText(fileToRead) {
      var reader = new FileReader();
      // Read file into memory as UTF-8      
      reader.readAsText(fileToRead);
      // Handle errors load
      reader.onload = loadHandler;
      reader.onerror = errorHandler;
    }

    function loadHandler(event) {
		var csv = event.target.result;
      processData(csv);
	
    }
	function csvToArray (csv) {
		rows = csv.split("\n");

    return rows.map(function (row) {
		return row.split(",");
    });
	};
    function processData(csv) {
		var allTextLines = csv.split(/\r\n|\n/);
		var _csvArray = csvToArray(csv);
		var TitleCol = _csvArray.shift();
		var col = [];
		for (var i =0; i<TitleCol.length;i++){
		 col[i] = {};
		 col[i].title = TitleCol[i];
		 $('#LatDropDownContent').append("<button class=\"dropdown-item\" type=\"button\" value="+TitleCol[i]+" >"+TitleCol[i]+"</button>");
		}
		 
        $('#example').DataTable({
		data:_csvArray,
		columns:col
		});
		 
		$('LatDropDownContent').append();
		 
        var lines = [];
        for (var i=1; i<allTextLines.length; i++) {
            var data = allTextLines[i].split(',');
            var tarr = [];
			//json.dumps(geoJsonData);
			geoJsonData.features.push({
                  type: 'Feature',
                  properties: {
						"FeatureName":data[2],
						"FeatureValue":Number(data[3]),
                        },
                  geometry: {
				  type: 'Point',
				  coordinates: [Number(data[1]), Number(data[0])]
                  }
				  
            });
        }
	  //omnivore.csv(lines).addTo(map);
      console.log("a22");
	
	  addlayerswithvalue(geoJsonData);
		
    }

    function errorHandler(evt) {
      if(evt.target.error.name == "NotReadableError") {
          alert("Canno't read file !");
      }
    }


</script>
</body>
</html>